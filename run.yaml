---

- name: CA generation
  hosts: registry
  vars_files:
    - vars/vars 
    - vars/common_vars 
    - vars/common_vault
  vars:
    - project_stage_dir: "{{ stage_dir }}/{{ project_id }}/{{ inventory_hostname }}"
  roles:
    - ca

- name: Get CA 
  hosts: registry
  vars_files:
    - vars/vars 
    - vars/common_vars 
    - vars/common_vault
  vars:
    - project_stage_dir: "{{ stage_dir }}/{{ project_id }}/{{ inventory_hostname }}"
  tasks:
    - name: sync the CA
      synchronize:
        src: "{{ ca_dir }}/"
        dest: ca/
        mode: pull

- name: Propagate CA
  hosts: dest
  serial: 1
  vars_files:
    - vars/vars 
    - vars/common_vars 
    - vars/common_vault
  vars:
    - project_stage_dir: "{{ stage_dir }}/{{ project_id }}/{{ inventory_hostname }}"
  tasks:
    - name: make sure that ca directory exists
      file: path={{ ca_dir }} state=directory
    - name: sync the CA
      copy: src=ca/ca.pem dest="{{ ca_dir }}/ca.pem"
    - name: sync the CA key
      copy: src=ca/ca-key.pem dest="{{ ca_dir }}/ca-key.pem"
    - name: create folder for trusted ca
      file: path=/usr/local/share/ca-certificates/{{ project_id }} state=directory
      become: true
      become_user: root
    - name: transfer the CA certificate
      copy: remote_src=True src="{{ ca_dir }}/ca.pem" dest=/usr/local/share/ca-certificates/{{ project_id }}/ca.crt
      become: true
      become_user: root

- name: Update CA
  hosts: dest
  serial: 1
  vars_files:
    - vars/vars 
    - vars/common_vars 
    - vars/common_vault
  vars:
    - project_stage_dir: "{{ stage_dir }}/{{ project_id }}/{{ inventory_hostname }}"
  tasks:  
    - name: update list of trusted CAs 
      command: update-ca-certificates
      become: true
      become_user: root
    - name: restart docker
      service: name=docker state=restarted
      become: true
      become_user: root

- name: create registry
  hosts: registry
  vars_files:
    - vars/vars 
    - vars/common_vars 
    - vars/common_vault
  vars:
    - project_stage_dir: "{{ stage_dir }}/{{ project_id }}/{{ inventory_hostname }}"
  roles:
    - registry

- name: login
  hosts: dest
  vars_files:
    - vars/vars 
    - vars/common_vars 
    - vars/common_vault
  vars:
    - project_stage_dir: "{{ stage_dir }}/{{ project_id }}/{{ inventory_hostname }}"
  tasks:
    - name: login to the registry
      command: docker login -u {{ registry_user }} -p {{ registry_pass }} -e null https://{{ docker_registry }}
